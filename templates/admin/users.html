{% extends "base.html" %}

{% block title %}Manage users | Lumina Host{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="glass-panel rounded-2xl p-8 shadow-xl border border-white/10">
        <h1 class="text-2xl font-bold text-white mb-2 tracking-tight">Manage users</h1>
        <p class="text-slate-400 text-sm mb-8">Create and manage user accounts.</p>

        <div class="mb-8">
            <h2 class="text-lg font-semibold text-white mb-4">Create user</h2>
            <form id="create-user-form" class="flex flex-wrap gap-4 items-end">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div>
                    <label for="new-username" class="block text-xs text-slate-400 mb-1">Username</label>
                    <input type="text" id="new-username" name="username" required maxlength="64" class="bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm w-40">
                </div>
                <div>
                    <label for="new-email" class="block text-xs text-slate-400 mb-1">Email</label>
                    <input type="email" id="new-email" name="email" required maxlength="256" class="bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm w-48">
                </div>
                <div>
                    <label for="new-password" class="block text-xs text-slate-400 mb-1">Password</label>
                    <input type="password" id="new-password" name="password" required minlength="8" class="bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm w-40">
                </div>
                <div>
                    <label for="new-role" class="block text-xs text-slate-400 mb-1">Role</label>
                    <select id="new-role" name="role" class="bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm w-24">
                        <option value="user">user</option>
                        <option value="admin">admin</option>
                    </select>
                </div>
                <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-emerald-400 hover:bg-emerald-500/30 text-sm font-medium">Create</button>
            </form>
        </div>

        <h2 class="text-lg font-semibold text-white mb-4">Users</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-left text-slate-400 border-b border-white/10">
                        <th class="pb-3 pr-4">Username</th>
                        <th class="pb-3 pr-4">Email</th>
                        <th class="pb-3 pr-4">Role</th>
                        <th class="pb-3"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <tr class="border-b border-white/5" data-id="{{ u.id }}">
                        <td class="py-3 pr-4 text-white">{{ u.username }}</td>
                        <td class="py-3 pr-4 text-slate-400">{{ u.email }}</td>
                        <td class="py-3 pr-4 text-slate-300">{{ u.role }}</td>
                        <td class="py-3">
                            {% if u.id != current_user.id %}
                            <button type="button" class="deactivate-user text-rose-400 hover:text-rose-300 text-xs" data-id="{{ u.id }}">Deactivate</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="py-6 text-slate-500 text-center">No users.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <p class="mt-8">
            <a href="{{ url_for('profile') }}" class="text-emerald-400 hover:text-emerald-300 text-sm">Profile</a>
            &middot; <a href="{{ url_for('index') }}" class="text-indigo-400 hover:text-indigo-300 text-sm">Gallery</a>
        </p>
    </div>
</div>

<script>
(function() {
    const csrf = document.querySelector('meta[name="csrf-token"]').content;
    document.getElementById('create-user-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const fd = new FormData(this);
        const body = { username: fd.get('username'), email: fd.get('email'), password: fd.get('password'), role: fd.get('role') };
        fetch('/admin/users', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
            credentials: 'same-origin',
            body: JSON.stringify(body)
        }).then(r => r.json()).then(data => {
            if (data.id) { window.location.reload(); }
            else if (data.error) { alert(data.error); }
        });
    });
    document.querySelectorAll('.deactivate-user').forEach(btn => {
        btn.addEventListener('click', function() {
            if (!confirm('Deactivate this user?')) return;
            const id = parseInt(this.dataset.id, 10);
            fetch('/admin/users/' + id, {
                method: 'DELETE',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrf },
                credentials: 'same-origin'
            }).then(r => r.json()).then(data => { if (data.message) window.location.reload(); });
        });
    });
})();
</script>
{% endblock %}
